---

- name: Ensure Magento dependencies are installed
  package:
    name: "{{ item }}"
    state: present
  loop:
     - composer
     - libmcrypt-dev
     - php-gd
     - php-dom
     - php-curl
     - php-intl
     - php-mbstring
     - php-zip
     - php-bcmath
     - php-soap
     - php-mysql
     - php-xdebug
  notify: 
    - reload apache


- name: Ensure mcrypt is installed
  command: '/usr/bin/php -me'
  register: mcrypt_ext_installed
  
- name: debug the variable
  debug: 
    var: mcrypt_ext_installed
    
- name: Install the mcrypt extension
  shell: 'printf "\n" | pecl install mcrypt channel://pecl.php.net/mcrypt-{{mcrypt_vers}}'
  when:  mcrypt_pkg_name not in mcrypt_ext_installed.stdout

- name: Create the mcrypt extension ini file
  copy:
    dest: "/etc/php/7.2/mods-available/mcrypt.ini"
    owner: root
    group: root
    mode: 0644
    content: |
      ;generated by magento-ansible
      extension=mcrypt.so

- name: Enable the mcrypt extension ini file
  shell: 'phpenmod mcrypt'
  when:  mcrypt_pkg_name not in mcrypt_ext_installed.stdout

- name: Check if composer files are present
  command: 'stat /var/www/vhosts/{{domain}}/pub'
  register: magento_present
  ignore_errors: yes

- name: Set repo.magento.com composer keys
  shell: 'composer config --global http-basic.repo.magento.com b2f5cba61c010a8eb9e563dc7f031db2 842ab5320d751c878cdc488f3e5ddf6a'
  environment:
    HOME: "/root"
  when: magento_present is failed

- name: download magento with composer
  shell: 'composer create-project --repository=https://repo.magento.com/ magento/project-community-edition /var/www/vhosts/{{domain}}'
  environment:
    HOME: "/root"
  when: magento_present is failed

- name: Ensure web directories have correct owner, group, and mode
  file:
    state: directory
    recurse: yes
    owner: "{{ magento_os_user }}"
    group: "{{ magento_os_group }}"
    path: '/var/www/vhosts/{{domain}}'
    mode: 'u=rwX,g=+w+X,o=rX'


- name: Configure Directory Level Permissions for media
  command: "{{ find_dirs_cmd }}"
  args:
    chdir: '/var/www/vhosts/{{domain}}'
  register: file_perm_change
  changed_when: file_perm_change.stdout



